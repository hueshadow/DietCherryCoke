---
import { getCollection, render } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import JsonLd from '../../components/JsonLd.astro';

export async function getStaticPaths() {
  const comparisons = await getCollection('comparisons', ({ data }) => !data.draft);
  return comparisons.map((comparison) => ({
    params: { slug: comparison.id },
    props: { comparison },
  }));
}

const { comparison } = Astro.props;
const { Content } = await render(comparison);
const { title, description, productA, productB, verdict, image } = comparison.data;

const breadcrumbs = [
  { label: 'Compare', href: '/compare' },
  { label: title },
];
---

<ArticleLayout
  title={title}
  description={description}
  image={image?.src}
  breadcrumbs={breadcrumbs}
>
  <header class="mb-8">
    <h1 class="text-3xl font-bold sm:text-4xl">{title}</h1>
    <p class="mt-3 text-text-secondary">{description}</p>

    <!-- Winner / Verdict Card -->
    <div class="mt-6 rounded-lg border border-accent/30 bg-bg-tertiary p-5">
      <h2 class="mb-2 text-sm font-semibold uppercase tracking-wider text-accent">Our Verdict</h2>
      <p class="text-text-secondary">{verdict}</p>
    </div>

    <!-- Quick Comparison -->
    <div class="mt-6 grid grid-cols-2 gap-4">
      <div class="rounded-lg border border-accent bg-bg-card p-4 text-center">
        <p class="text-sm text-text-muted">{productA.brand}</p>
        <p class="mt-1 text-lg font-bold text-accent">{productA.name}</p>
      </div>
      <div class="rounded-lg border border-border bg-bg-card p-4 text-center">
        <p class="text-sm text-text-muted">{productB.brand}</p>
        <p class="mt-1 text-lg font-bold text-text-primary">{productB.name}</p>
      </div>
    </div>
  </header>

  <div class="prose prose-invert max-w-none">
    <Content />
  </div>

  <!-- Related Comparisons -->
  <div slot="sidebar" class="rounded-lg border border-border bg-bg-card p-5">
    <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-text-muted">More Comparisons</h3>
    <ul class="space-y-2 text-sm">
      <li><a href="/compare" class="text-text-secondary hover:text-text-primary">All Comparisons</a></li>
      <li><a href="/nutrition" class="text-text-secondary hover:text-text-primary">Nutrition Facts</a></li>
      <li><a href="/where-to-buy" class="text-text-secondary hover:text-text-primary">Where to Buy</a></li>
    </ul>
  </div>

  <!-- JSON-LD for both products -->
  <Fragment slot="schema">
    <JsonLd
      type="Product"
      data={{
        name: productA.name,
        description: `${productA.name} by ${productA.brand}`,
        brand: productA.brand,
        image: image?.src,
      }}
    />
    <JsonLd
      type="Product"
      data={{
        name: productB.name,
        description: `${productB.name} by ${productB.brand}`,
        brand: productB.brand,
      }}
    />
  </Fragment>
</ArticleLayout>
